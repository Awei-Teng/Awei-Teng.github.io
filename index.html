<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>临在记录</title>
		 <meta name ="viewport" content ="initial-scale=1, maximum-scale=3, minimum-scale=1, user-scalable=no">
		<style type="text/css">
			#body{
				font-size: 36px;
				line-height: 60px;
				width: 250px;
				margin: 20px auto;
			}
			[v-cloak]{
			    display: none;
			}
		</style>
	</head>
	<body>
		<div id="app" v-cloak>
			<section id="body">
				<section style="font-size: 18px;">
					临在状态：{{currentDate}}
				</section>
				<!-- 得分 -->
				<section id="total">
					总分：<span style="color: red;">{{60 - scoreLoss + targetGet}}</span>
				</section>
				<!-- 扣分 -->
				<section id="loss">
					扣除分数：{{scoreLoss}}
				</section>
				<section>
					<button @click="countChange(1)" style="width: 100px;height: 38px;">减一</button>
					<button @click="countChange(-1)" style="width: 50px;height: 38px;">加一</button>
				</section>
				<section>
					目标得数：{{targetGet}}
				</section>
				<section>
					<button @click="countChange2(1)" style="width: 100px;height: 38px;">加一</button>
					<button @click="countChange2(-1)" style="width: 50px;height: 38px;">减一</button>
				</section>
				<!-- <section>
					<input type="number" name="" id="" v-model="inputLoss"  style="width: 112px;height: 30px;"/>
					<button @click="lossChange" style="width: 80px;height: 38px;">确定</button>
				</section> -->
				<!-- 过去数据 -->
				<section id="loss" style="font-size: 10px;line-height: 14px;margin-top: 20px;">
					过去数据：
					<ul>
						<li v-for="(item,index) in flowData" :key="index">
							date: {{item.date}}, scoreLoss: {{item.scoreLoss}}, targetGet: {{item.targetGet}}
						</li>
					</ul>
				</section>
			</section>
		</div>
	</body>
</html>
<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.11/vue.js"></script>
<script type="text/javascript">
	new Vue({
		el: '#app',
		data: {
			scoreLoss: 0,
			targetGet: 0,
			inputLoss:null,
			currentDate:'---'
		},
		mounted(){
			this.getScore()
			setInterval(()=>{
				this.syncStorage()
			},1000)
		},
		computed:{
			flowData(){
				let _flowData = JSON.parse(window.localStorage.getItem('flowData'))
				if(_flowData){
					_flowData.pop()
					return _flowData
				}
			},
			popItem(){
				let _flowData = JSON.parse(window.localStorage.getItem('flowData'))
				if(_flowData){
					return _flowData.pop()
				}
			},
			isToday(){
				return this.popItem ? this.popItem.date ==this.dateFormat('YYYY-mm-dd',new Date()) :true
			}
		},
		methods: {
			
			syncStorage(){
				if(this.isToday){
					// this.setLocalStorage([...this.flowData,this.getNowItem()])
				}else{
					this.setLocalStorage([...this.flowData,this.popItem,this.getNowItem()])
				}
			},
			countChange2(count){
				this.targetGet += count
				this.setLocalStorage([...this.flowData,this.getNowItem()])
			},
			countChange(count){
				this.inputLoss = count
				this.lossChange()
			},
			//目标事件
			lossChange2(){
				this.scoreLoss += Number(this.inputLoss)
				this.inputLoss = null
				this.setLocalStorage([...this.flowData,this.getNowItem()])
			},
			//扣分事件
			lossChange(){
				this.scoreLoss += Number(this.inputLoss)
				this.inputLoss = null
				this.setLocalStorage([...this.flowData,this.getNowItem()])
			},
			// 1小时加6分，10分钟无序-1，30分钟无序 - 5；一小时无序 -15
			getScore() {
				if(this.flowData){
					//有今天数据
					if(this.isToday){
						this.scoreLoss = this.popItem.scoreLoss
						this.targetGet = this.popItem.targetGet || 0
					}else{
						this.setLocalStorage([...this.flowData,this.popItem,this.getNowItem()])
					}
				}else{
					//第一次访问初始化
					this.setLocalStorage([this.getNowItem()])
				}
					console.log(JSON.parse(window.localStorage.getItem('flowData')).pop())
					this.currentDate = JSON.parse(window.localStorage.getItem('flowData')).pop().date
			},
			//获取新的临在对象
			getNowItem(){
				//7点第一次执行，重置扣分
				if(!this.isToday){
					this.scoreLoss = 0
					this.targetGet = 0
				}
				const item = {
					date:this.dateFormat('YYYY-mm-dd',new Date()),
					scoreLoss:this.scoreLoss,
					targetGet:this.targetGet
				}
				return item;
			},
			//设置localStorage
			setLocalStorage(data){
				localStorage.setItem('flowData',JSON.stringify(data))
			},
			//YYYY-mm-dd HH:MM表示2019-06-06 19:45
			dateFormat(fmt, date) {
			    let ret;
			    const opt = {
			        "Y+": date.getFullYear().toString(),        // 年
			        "m+": (date.getMonth() + 1).toString(),     // 月
			        "d+": date.getDate().toString(),            // 日
			        "H+": date.getHours().toString(),           // 时
			        "M+": date.getMinutes().toString(),         // 分
			        "S+": date.getSeconds().toString()          // 秒
			        // 有其他格式化字符需求可以继续添加，必须转化成字符串
			    };
			    for (let k in opt) {
			        ret = new RegExp("(" + k + ")").exec(fmt);
			        if (ret) {
			            fmt = fmt.replace(ret[1], (ret[1].length == 1) ? (opt[k]) : (opt[k].padStart(ret[1].length, "0")))
			        };
			    };
			    return fmt;
			}

		}
	})
</script>
